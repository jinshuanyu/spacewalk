<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spacewalk 太空漫遊</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tone.js library for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script> 
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #000033, #000000); /* Deep space background */
            color: #E0E7FF; /* Light text for contrast */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px; /* Further reduced body padding */
            font-size: 1.1rem; /* Base font size increased */
        }

        .game-container {
            background-color: rgba(25, 25, 50, 0.8); /* Semi-transparent dark blue */
            border-radius: 20px;
            padding: 20px; /* Further reduced container padding */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px; /* Reduced gap between sections */
        }

        h1 {
            font-size: 2.8rem; /* Larger heading */
            margin-bottom: 10px; /* Reduced margin */
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(10, minmax(0, 1fr));
            gap: 3px; /* Further reduced cell gap */
            background-color: rgba(10, 10, 30, 0.7);
            border-radius: 15px;
            padding: 6px; /* Further reduced board padding */
            border: 2px solid #3B82F6; /* Blue border */
            box-shadow: inset 0 0 15px rgba(59, 130, 246, 0.5);
        }

        .board-cell {
            width: 100%;
            padding-top: 100%; /* Makes cells square */
            position: relative;
            background-color: rgba(60, 60, 90, 0.5); /* Slightly lighter cell background */
            /* Removed border-radius for square cells */
            border: 1px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease-in-out;
            display: flex; /* Added flex to center content */
            align-items: center; /* Center content vertically */
            justify-content: center; /* Center content horizontally */
        }

        .board-cell span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.4rem; /* Adjusted cell number font size */
            font-weight: 600;
            color: #A7CCED; /* Light blue number color */
        }

        /* Player token highlights on cells */
        .board-cell.player-active-1 { background-color: #F87171; color: white; box-shadow: 0 0 15px rgba(248, 113, 113, 0.8), inset 0 0 10px rgba(248, 113, 113, 0.5); transform: scale(1.05); border-color: #EF4444; z-index: 2; }
        .board-cell.player-active-2 { background-color: #60A5FA; color: white; box-shadow: 0 0 15px rgba(96, 165, 250, 0.8), inset 0 0 10px rgba(96, 165, 250, 0.5); transform: scale(1.05); border-color: #3B82F6; z-index: 2; }
        .board-cell.player-active-3 { background-color: #A78BFA; color: white; box-shadow: 0 0 15px rgba(167, 139, 250, 0.8), inset 0 0 10px rgba(167, 139, 250, 0.5); transform: scale(1.05); border-color: #8B5CF6; z-index: 2; }
        .board-cell.player-active-4 { background-color: #4ADE80; color: white; box-shadow: 0 0 15px rgba(74, 222, 128, 0.8), inset 0 0 10px rgba(74, 222, 128, 0.5); transform: scale(1.05); border-color: #22C55E; z-index: 2; }

        /* Position 1 (Start) should look like a regular cell, no special styling here */
        .board-cell.end {
            background-color: yellow; /* Filled with yellow */
            color: #000000; /* Black text */
            font-size: 1.3rem; /* Larger font for start/end */
            font-weight: bold;
            text-shadow: none; /* Removed text shadow */
        }

        .player-token {
            position: absolute; /* Tokens inside cells use absolute position */
            font-size: 2rem; /* Larger emoji */
            line-height: 1;
            animation: pulse 1.5s infinite alternate; /* Subtle pulse animation */
            z-index: 3;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .player-token-1 { color: #DC2626; text-shadow: 0 0 8px rgba(220, 38, 38, 0.8); } /* Red glow for player 1 */
        .player-token-2 { color: #2563EB; text-shadow: 0 0 8px rgba(37, 99, 235, 0.8); } /* Blue glow for player 2 */
        .player-token-3 { color: #7C3AED; text-shadow: 0 0 8px rgba(124, 58, 237, 0.8); } /* Purple glow for player 3 */
        .player-token-4 { color: #16A34A; text-shadow: 0 0 8px rgba(22, 163, 74, 0.8); } /* Green glow for player 4 */


        .control-panel {
            background-color: rgba(35, 35, 65, 0.9);
            border-radius: 15px;
            padding: 15px; /* Reduced control panel padding */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            gap: 15px; /* Increased gap for better separation of sections */
            border: 1px solid #60A5FA;
        }

        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-lg transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            font-size: 1.1rem; /* Larger button text */
        }
        .btn-primary:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%, -50%);
            transform-origin: 50% 50%;
        }
        .btn-primary:active:after {
            transition: all 0.2s ease-out;
            transform: scale(100, 100) translate(-50%, -50%);
            opacity: 1;
        }

        .btn-secondary {
            @apply bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-lg transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50;
            font-size: 1.1rem; /* Larger button text */
        }
        .btn-red {
             @apply bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-lg transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50;
             font-size: 1.1rem; /* Larger button text */
        }
        .btn-green {
             @apply bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-lg transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50;
             font-size: 1.1rem; /* Larger button text */
        }
        .btn-info {
            @apply bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-lg transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-500 focus:ring-opacity-50;
            font-size: 1.1rem; /* Larger button text */
        }

        /* Adjusted input and button for inline display */
        .input-btn-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px; /* Increased gap between input and button */
            width: 100%; /* Ensure group takes full width */
            padding-top: 5px; /* Add a bit of padding above the input-button group itself */
            padding-bottom: 5px; /* Add a bit of padding below */
        }

        input[type="number"] {
            @apply p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500;
            font-size: 1.3rem; /* Increased input text size */
            color: #000000 !important; /* Force black text */
            text-align: center; /* Center text */
            max-width: 120px; /* Even narrower input width */
            padding-left: 0.75rem; /* Adjust horizontal padding */
            padding-right: 0.75rem; /* Adjust horizontal padding */
            flex-grow: 0; /* Don't grow too much */
        }
        
        .btn-confirm {
            @apply bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-lg transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50;
            font-size: 1.3rem; /* Increased button text size */
            white-space: nowrap; /* Prevent text wrap */
            min-width: 100px; /* Ensure button has decent width */
        }

        select {
             @apply p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500;
             font-size: 1.1rem; /* Larger select text */
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #3B82F6;
            border-radius: 15px;
            padding: 30px;
            z-index: 1000;
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.7);
            text-align: center;
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 20px;
            max-width: 90%;
            min-width: 300px;
        }

        .message-box h3 {
            font-size: 2.2rem; /* Larger message box title */
            color: #FACC15;
            margin-bottom: 10px;
        }

        .message-box p {
            font-size: 1.3rem; /* Larger message box text */
            color: #E0E7FF;
        }

        .message-box button {
            @apply btn-primary;
            margin-top: 20px;
        }

        /* Dice animation specific to the emoji */
        .dice-display {
            font-size: 3.5rem; /* Larger dice emoji */
            line-height: 1;
            filter: drop-shadow(0 0 10px #FACC15);
            animation: roll-anim 0.5s ease-out; /* Dice roll animation */
        }
        @keyframes roll-anim {
            0% { transform: rotateY(0deg) scale(0.8); opacity: 0; }
            50% { transform: rotateY(360deg) scale(1.1); opacity: 1; }
            100% { transform: rotateY(720deg) scale(1); opacity: 1; }
        }

        /* Container for the main dice display, moved outside control panel */
        #main-dice-display-area {
            min-height: 70px; /* Ensure space for dice even if not visible */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%; /* Ensure it takes full width for centering */
            margin-bottom: 5px; /* Reduced margin */
            z-index: 10; /* Ensure it stays on top of other game UI elements */
        }


        /* Adjusted styles for button text and emoji sizes */
        .btn-action-text {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            font-size: 1.5rem; /* Adjusted text size for buttons to match player count label */
            font-weight: bold; /* Make it bold */
        }

        .btn-action-emoji {
            font-size: 2.0rem; /* Adjusted for proportionality */
            line-height: 1;
        }

        /* Start Line Container */
        #start-line-container {
            background-color: rgba(50, 50, 80, 0.6);
            border: 2px dashed #60A5FA;
            border-radius: 10px;
            padding: 10px 15px; /* Adjusted padding for better visual alignment */
            margin-top: 15px;
            margin-bottom: 15px;
            max-width: 900px; /* Match game-container max-width */
            width: 100%; /* Ensure responsiveness */
            margin-left: auto; /* Center horizontally */
            margin-right: auto; /* Center horizontally */
            min-height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px; /* Reduced spacing between start tokens and label */
            flex-wrap: wrap; 
            font-size: 1.2rem;
            color: #A7CCED;
        }

        #start-line-label {
            font-weight: bold;
            font-size: 1.2rem; /* Adjusted font size for "起點" label */
            color: #FACC15; 
            margin-right: 6px; /* Space between label and first token */
            white-space: nowrap; 
        }

        .start-token {
            font-size: 2rem; 
            animation: pulse 1.5s infinite alternate; 
            position: static; 
        }

        #game-message {
            line-height: 1.2em; /* Use relative units for line height */
            font-size: 1.5rem; 
            font-weight: bold; 
            min-height: 1.2em; /* Adjusted min-height to match line-height */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 0; 
            padding-bottom: 0; 
        }

        #feedback-message {
            text-align: center;
            font-size: 1.3rem; /* Increased feedback message font size */
            color: #FACC15; 
            line-height: 1em; /* Use relative units for line height */
            min-height: 1em; /* Adjusted min-height to match line-height */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0; 
            padding-bottom: 0; 
        }

        #roll-1-reminder {
            margin-top: 0; /* Changed from 0.5rem to 0 to remove top space */
            margin-bottom: 0.1rem; 
            font-size: 1.0rem; 
            color: #E0E7FF; 
            opacity: 0.8; 
            text-align: center;
        }

        /* Style for the player count label in start screen */
        #player-count-label {
            font-size: 1.5rem; 
            font-weight: bold;
            margin-bottom: 10px; 
        }


        #player-info-section {
            margin-top: 10px; 
            margin-bottom: 10px; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 8px; /* Reduced gap for more compact display */
        }

        /* Style for individual player info items to reduce vertical spacing within the flex container */
        #player-info-section > div {
            margin: 0; 
            padding: 2px 5px; 
            line-height: 1.2; 
            white-space: nowrap; /* Prevent text wrap */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis if text is truncated */
        }
        
        /* Rules Modal */
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none; 
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .rules-content {
            background-color: rgba(25, 25, 50, 0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.8);
            position: relative;
        }
        .rules-content h2 {
            font-size: 2.5rem;
            color: #FACC15;
            margin-bottom: 20px;
            text-align: center;
        }
        .rules-content h3 { /* Added rule for h3 in rules content */
            font-size: 1.8rem; /* Increased h3 font size */
            color: #93C5FD; /* Light blue color for subheadings */
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .rules-content p, .rules-content ul, .rules-content ol { 
            font-size: 1.3rem; /* Increased rules content font size */
            line-height: 1.6;
            color: #E0E7FF;
            margin-bottom: 15px;
        }
        .rules-content ul, .rules-content ol {
            list-style: disc;
            margin-left: 25px;
        }
        .close-rules-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2rem;
            color: #E0E7FF;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .close-rules-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Responsive adjustments */
        @media (min-width: 769px) {
            #player-info-section {
                /* Changed to grid for better 2x2 control */
                display: flex; /* Revert to flex for 3 players to be in one row naturally */
                grid-template-columns: none; /* Disable grid for 3 players */
                gap: 20px; /* Adjust gap for wider screens */
                justify-content: center; /* Center items within their flex container */
            }
            #player-info-section > div {
                text-align: center; /* Center each player info */
                width: auto; /* Allow auto width for flexible layout */
            }
            /* Specific 2x2 layout for 4 players on larger screens */
            #player-count-select option[value="4"]:checked ~ #player-info-section {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px 40px;
                justify-items: center;
            }
        }

        @media (max-width: 768px) {
            body {
                font-size: 1rem; 
                padding: 8px;
            }
            .game-container {
                padding: 15px;
                gap: 8px;
            }
            h1 {
                font-size: 2.2rem;
                margin-bottom: 8px;
            }
            .game-board {
                gap: 2px;
                padding: 8px;
            }
            .board-cell {
                font-size: 0.8rem;
            }
             .board-cell span {
                font-size: 1.1rem; /* Adjusted for mobile */
            }
            .board-cell.start, .board-cell.end {
                font-size: 0.9rem;
            }
            .player-token {
                font-size: 1.6rem;
            }
            .control-panel {
                padding: 12px;
                gap: 10px; /* Reduced for mobile, but still larger than previous */
            }
            .btn-primary, .btn-secondary, .btn-red, .btn-green, .btn-info {
                font-size: 1rem;
                padding: 10px 15px;
            }
            .btn-action-text {
                font-size: 1.3rem; 
            }
            .btn-action-emoji {
                font-size: 1.8rem; 
            }
            .input-btn-group {
                gap: 10px; /* Reduced gap for mobile */
            }
            .input-btn-group input[type="number"], .input-btn-group .btn-confirm {
                font-size: 1.1rem; /* Adjusted for mobile */
                padding: 10px;
            }
            .input-btn-group input[type="number"] {
                max-width: 100px; 
            }
            .message-box, .rules-content {
                padding: 20px;
            }
            .message-box h3, .rules-content h2 {
                font-size: 1.8rem;
            }
            .rules-content h3 { /* Adjusted h3 for mobile */
                font-size: 1.6rem; 
            }
            .message-box p, .rules-content p, .rules-content ul, .rules-content ol {
                font-size: 1.1rem; /* Adjusted for mobile */
            }
            .dice-display {
                font-size: 3rem;
            }
            #player-info-section {
                gap: 8px; /* For mobile, even tighter gap */
                margin-top: 8px;
                margin-bottom: 8px;
            }
            #player-info-section > div {
                text-align: center; /* Ensure center alignment for single column */
                width: auto; /* Let it shrink to content */
            }
            .roll-1-reminder {
                font-size: 0.9rem;
            }
            #start-line-container {
                padding: 5px 8px;
                min-height: 45px;
                gap: 5px; 
                margin-top: 10px; 
                margin-bottom: 10px; 
            }
            .start-token {
                font-size: 1.6rem; 
            }
            #game-message {
                margin-bottom: 6px;
                font-size: 1.3rem; 
            }
            #player-count-label {
                font-size: 1.3rem; 
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="text-3xl font-bold text-center mb-6 text-yellow-300">🌌 太空漫遊 🚀</h1>

        <!-- Player Selection and Game Start -->
        <div id="start-screen" class="flex flex-col items-center gap-4 mb-6">
            <p id="player-count-label" class="text-xl text-blue-200">請選擇玩家人數：</p>
            <select id="player-count-select" class="p-2 rounded-lg bg-gray-700 text-white">
                <option value="2" selected>2 位玩家</option> <!-- Default to 2 players -->
                <option value="3">3 位玩家</option>
                <option value="4">4 位玩家</option>
            </select>
            <button id="start-game-btn" class="btn-green">
                <span class="btn-action-text">開始遊戲 <span class="btn-action-emoji">🚀</span></span>
            </button>
            <button id="show-rules-btn" class="btn-info">
                <span class="btn-action-text">遊戲說明 <span class="btn-action-emoji">ℹ️</span></span>
            </button>
        </div>

        <!-- Game Interface (Hidden initially) -->
        <div id="game-interface" class="hidden flex flex-col gap-0.5"> 
            <!-- Consolidated turn message (constant) -->
            <div id="game-message" class="text-center text-xl text-yellow-200 min-h-[1.2em] pb-0"></div> 
            <!-- Feedback/Prompt message (temporary) -->
            <div id="feedback-message" class="text-center text-yellow-300 text-lg min-h-[1em] pb-0"></div> 

            <!-- NEW LOCATION FOR DICE DISPLAY (Always visible for first math question) -->
            <div class="dice-container" id="main-dice-display-area">
                <span id="last-roll-display" class="dice-display hidden"></span>
            </div>

            <div class="control-panel flex flex-col items-center gap-4">
                <div class="flex flex-col items-center justify-center gap-2 flex-grow">
                    <button id="roll-dice-btn" class="btn-primary w-full max-w-[200px]">擲骰子 <span class="btn-action-emoji">🎲</span></button>
                </div>
                
                <!-- Display for current turn accumulated steps -->
                <div id="current-turn-info" class="text-center text-lg text-purple-300 hidden w-full">
                    本回合累積步數：<strong id="accumulated-steps-display" class="font-bold text-yellow-200">0</strong> 步
                </div>

                <div id="action-buttons" class="flex flex-row justify-center items-center gap-x-2 gap-y-0 hidden w-full">
                    <button id="roll-again-btn" class="btn-secondary">
                        <span class="btn-action-text">再擲 <span class="btn-action-emoji">🎲</span></span>
                    </button>
                    <span class="text-white text-lg font-bold">或</span>
                    <button id="move-steps-btn" class="btn-green">
                        <span class="btn-action-text">前進 <span class="btn-action-emoji">👉</span></span>
                    </button>
                </div>

                <!-- Roll Sum Calculation Panel -->
                <div id="roll-sum-panel" class="flex flex-col items-center gap-2 w-full hidden">
                    <p id="roll-sum-question" class="text-lg text-yellow-100 text-center"></p>
                    <div class="input-btn-group">
                        <input type="number" id="roll-sum-input" inputmode="numeric" />
                        <button id="check-roll-sum-btn" class="btn-confirm">確認 ✅</button>
                    </div>
                </div>

                <!-- Addition (New Position) Panel -->
                <div id="addition-panel" class="flex flex-col items-center gap-2 w-full hidden">
                    <p id="addition-question" class="text-lg text-yellow-100 text-center"></p>
                    <div class="input-btn-group">
                        <input type="number" id="answer-input" inputmode="numeric" />
                        <button id="check-answer-btn" class="btn-confirm">確認 ✅</button>
                    </div>
                </div>
            </div>

            <!-- Roll 1 reminder moved below control panel -->
            <p id="roll-1-reminder" class="text-center text-red-300 text-base mt-0 mb-0.1 hidden">💡 如果擲到 1 點，本回合步數歸 0，換下家！</p> 

            <div id="player-info-section" class="flex flex-wrap justify-center items-center gap-x-6 gap-y-2 mb-4">
                <!-- Player info will be dynamically generated here -->
            </div>

            <!-- Start Line Container moved outside control-panel, above game-board -->
            <div id="start-line-container" class="w-full hidden">
                <span id="start-line-label">起點</span>
                <!-- Player tokens at start will be dynamically added here -->
            </div>

            <div class="game-board" id="game-board">
                <!-- Board cells will be generated here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Message Box for game announcements (e.g., win, incorrect answer) -->
    <div id="message-box" class="message-box">
        <h3 id="message-title"></h3>
        <p id="message-content"></p>
        <button id="close-message-btn">確定</button>
    </div>

    <!-- Game Rules Modal -->
    <div id="rules-modal" class="rules-modal">
        <div class="rules-content">
            <button id="close-rules-btn" class="close-rules-btn">&times;</button>
            <h2 class="text-center font-bold text-yellow-300">🌌 太空漫遊 🚀</h2>

            <h3>遊戲目標</h3>
            <ul>
                <li>最先把太空船移動到 100 的玩家獲勝。</li>
            </ul>

            <h3>玩法說明</h3>
            <ol>
                <li>選擇 <strong>2 到 4 位玩家</strong>開始遊戲，玩家輪流進行。</li>
                <li>點擊「<strong>擲骰子 🎲</strong>」開始回合。</li>
            </ol>

            <h3>擲骰規則</h3>
            <ul>
                <li><strong>擲出 1：</strong> 累積步數歸零，本回合結束，輪到下一位玩家。</li>
                <li><strong>擲出 2–6：</strong>
                    <ul>
                        <li><strong>第一次擲骰（累積 0 步）：：</strong> 點數會直接計入「本回合累積步數」，無需計算。</li>
                        <li><strong>非第一次擲骰（已有累積步數）：：</strong> 需心算「目前累積步數」加上「這次擲出的點數」。答對才能計入累積步數。</li>
                    </ul>
                </li>
            </ul>

            <h3>策略選擇</h3>
            <ul>
                <li><strong>擲出 2–6 時：</strong>
                    <ul>
                        <li>可以選擇「<strong>前進 👉</strong>」見好就收，將累積步數安全移動到太空船位置。</li>
                        <li>也可以選擇「<strong>再擲 🎲</strong>」放手一搏，讓步數繼續增加，但會有額外風險。</li>
                    </ul>
                </li>
                <li><strong>風險：：</strong> 若在累積步數後選擇「再擲 🎲」卻不幸擲出 1，本回合累積的所有步數將全數歸零，並輪到下一位玩家。</li>
            </ul>

            <h3>前進挑戰</h3>
            <ul>
                <li><strong>從起點出發 (位置 0)：：</strong> 太空船會直接移動到累積步數的位置，無需計算。</li>
                <li><strong>從非起點位置前進：：</strong> 需心算「目前太空船位置」加上「本回合累積步數」的新位置。答對才前進。</li>
            </ul>

            <h3>勝利條件</h3>
            <ul>
                <li>任何玩家的太空船只要到達或超過數字 100，即為遊戲勝利者！</li>
            </ul>

            <p class="text-center font-bold text-lg text-purple-300">祝你玩得開心，也練好加法！ 🚀</p>
        </div>
    </div>

    <!-- Copyright Statement -->
    <div class="text-center text-gray-500 text-sm mt-4">
        © 2025 Christina Yu. All rights reserved.
    </div>

    <script type="module">
        // Firebase imports (mandatory for Canvas environment, even if not actively used for game data)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for game state and Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        let app;
        let db;
        let auth;
        let userId;

        // Game State Variables
        const PLAYER_EMOJIS = ['🪐', '🛰️', '🚀', '🛸']; // Changed player 4 emoji to UFO
        const PLAYER_COLORS = ['#DC2626', '#2563EB', '#7C3AED', '#16A34A']; // Corresponding colors
        let players = [];
        let currentPlayerIndex = 0;
        let currentAccumulatedStepsThisTurn = 0; // The actual accumulated steps, updated only on correct mental math
        let lastRollValue = 0; // The value of the last dice roll, used for calculation question
        let currentQuestionCorrectAnswer = 0; // The correct answer for the current mental math question (either sum of rolls or new position)

        // Tone.js Synths for sound effects
        let diceRollSynth;
        let correctSynth;
        let incorrectSynth;
        let penaltySynth; // For rolling a 1
        let moveSynth;
        let winSynth;
        let playerTurnSynth; // New synth for player turn change

        // Declare DOM Elements globally with 'let'
        let startScreen;
        let gameInterface;
        let playerCountSelect;
        let startGameBtn;
        let showRulesBtn;
        let playerCountLabel; 

        let gameBoard;
        let rollDiceBtn;
        let lastRollDisplay; // The span element displaying the dice emoji
        let mainDiceDisplayArea; // The container div for the lastRollDisplay span
        let gameMessage; 
        let feedbackMessage; 

        let roll1Reminder;

        let currentTurnInfo;
        let accumulatedStepsDisplay;

        let actionButtons;
        let rollAgainBtn;
        let moveStepsBtn;

        let rollSumPanel;
        let rollSumQuestion;
        let rollSumInput;
        let checkRollSumBtn;

        let additionPanel;
        let additionQuestion;
        let answerInput;
        let checkAnswerBtn;

        let messageBox;
        let messageTitle;
        let messageContent;
        let closeMessageBoxBtn;

        let rulesModal;
        let closeRulesBtn;

        let startLineContainer;
        let startLineLabel; 
        let playerInfoSection; 

        // --- Tone.js Sound Initialization ---
        function initAudioSynths() {
            // Cute Dice Roll Sound (polyphonic, playful)
            diceRollSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "triangle" },
                envelope: {
                    attack: 0.005,
                    decay: 0.1,
                    sustain: 0.05,
                    release: 0.1
                }
            }).toDestination();
            diceRollSynth.set({
                "volume": -10, // Slightly reduce volume
                "detune": 0 // No detune for now
            });


            // Correct Answer Sound (upbeat, positive)
            correctSynth = new Tone.Synth({
                oscillator: { type: "triangle" },
                envelope: {
                    attack: 0.02,
                    decay: 0.1,
                    sustain: 0.1,
                    release: 0.2
                }
            }).toDestination();

            // Incorrect Answer Sound (dissonant, short)
            incorrectSynth = new Tone.Synth({
                oscillator: { type: "sawtooth" },
                envelope: {
                    attack: 0.01,
                    decay: 0.05,
                    sustain: 0.01,
                    release: 0.1
                }
            }).toDestination();

            // Penalty Sound (for rolling a 1, an "uh-oh" sound)
            penaltySynth = new Tone.Synth({
                oscillator: { type: "triangle" }, // Use triangle for a softer, more "uh-oh" feel
                envelope: {
                    attack: 0.01,
                    decay: 0.15, // Slightly longer decay for the "fall"
                    sustain: 0.0,
                    release: 0.1 // Quick release
                }
            }).toDestination();
            penaltySynth.set({ "volume": -8 });

            // Player Move Sound (short, clean tone)
            moveSynth = new Tone.Synth({
                oscillator: { type: "square" },
                envelope: {
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.05,
                    release: 0.1
                }
            }).toDestination();

            // Win Sound (fanfare-like)
            winSynth = new Tone.Synth({
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.05,
                    decay: 0.4,
                    sustain: 0.2,
                    release: 1
                }
            }).toDestination();

            // Player Turn Change Sound (soft, rising arpeggio)
            playerTurnSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0.0,
                    release: 0.2
                }
            }).toDestination();
            playerTurnSynth.set({ "volume": -12 });
        }

        // --- Audio Playback Functions ---
        function playDiceRollSound() {
            // Play a short, playful arpeggio
            diceRollSynth.triggerAttackRelease(["C5", "E5", "G5"], "16n"); // A quick C major chord
        }

        function playCorrectSound() {
            correctSynth.triggerAttackRelease("C5", "8n");
            correctSynth.triggerAttackRelease("E5", "8n", Tone.now() + 0.1);
            correctSynth.triggerAttackRelease("G5", "8n", Tone.now() + 0.2);
        }

        function playIncorrectSound() {
            incorrectSynth.triggerAttackRelease("C3", "16n");
            incorrectSynth.triggerAttackRelease("B2", "16n", Tone.now() + 0.05);
        }

        function playPenaltySound() {
            // A quick falling minor second (e.g., C4 to B3) for "uh-oh"
            penaltySynth.triggerAttackRelease("C4", "0.1");
            penaltySynth.triggerAttackRelease("B3", "0.1", Tone.now() + 0.1);
        }


        function playMoveSound() {
            moveSynth.triggerAttackRelease("A4", "16n");
        }

        function playWinSound() {
            winSynth.triggerAttackRelease("C4", "4n");
            winSynth.triggerAttackRelease("E4", "4n", Tone.now() + 0.3);
            winSynth.triggerAttackRelease("G4", "4n", Tone.now() + 0.6);
            winSynth.triggerAttackRelease("C5", "2n", Tone.now() + 0.9);
        }

        function playPlayerTurnSound() {
            playerTurnSynth.triggerAttackRelease(["C4", "E4", "G4"], "8n"); // A cheerful C major chord
        }

        // --- DOM Elements Initialization and Event Listeners ---
        function initDomElements() {
            startScreen = document.getElementById('start-screen');
            gameInterface = document.getElementById('game-interface');
            playerCountSelect = document.getElementById('player-count-select');
            startGameBtn = document.getElementById('start-game-btn');
            showRulesBtn = document.getElementById('show-rules-btn');
            playerCountLabel = document.getElementById('player-count-label'); 

            gameBoard = document.getElementById('game-board');
            rollDiceBtn = document.getElementById('roll-dice-btn');
            lastRollDisplay = document.getElementById('last-roll-display');
            mainDiceDisplayArea = document.getElementById('main-dice-display-area'); // Get the new container for dice
            gameMessage = document.getElementById('game-message');
            feedbackMessage = document.getElementById('feedback-message'); 

            roll1Reminder = document.getElementById('roll-1-reminder');

            currentTurnInfo = document.getElementById('current-turn-info');
            accumulatedStepsDisplay = document.getElementById('accumulated-steps-display');

            actionButtons = document.getElementById('action-buttons');
            rollAgainBtn = document.getElementById('roll-again-btn');
            moveStepsBtn = document.getElementById('move-steps-btn');

            rollSumPanel = document.getElementById('roll-sum-panel');
            rollSumQuestion = document.getElementById('roll-sum-question');
            rollSumInput = document.getElementById('roll-sum-input');
            checkRollSumBtn = document.getElementById('check-roll-sum-btn');

            additionPanel = document.getElementById('addition-panel');
            additionQuestion = document.getElementById('addition-question');
            answerInput = document.getElementById('answer-input'); 
            checkAnswerBtn = document.getElementById('check-answer-btn'); 

            messageBox = document.getElementById('message-box');
            messageTitle = document.getElementById('message-title');
            messageContent = document.getElementById('message-content');
            closeMessageBoxBtn = document.getElementById('close-message-btn');

            rulesModal = document.getElementById('rules-modal');
            closeRulesBtn = document.getElementById('close-rules-btn');

            startLineContainer = document.getElementById('start-line-container');
            startLineLabel = document.getElementById('start-line-label'); 
            playerInfoSection = document.getElementById('player-info-section'); 


            // --- Event Listeners ---
            startGameBtn.addEventListener('click', () => {
                Tone.start(); // Start Tone.js context on first user interaction
                startGame();
            });
            rollDiceBtn.addEventListener('click', rollDice);
            rollAgainBtn.addEventListener('click', rollDice);
            moveStepsBtn.addEventListener('click', handleMoveSteps); 

            checkRollSumBtn.addEventListener('click', checkRollSum);
            rollSumInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkRollSum();
                }
            });
            rollSumInput.addEventListener('focus', () => {
                // Using setTimeout to allow browser's default scroll behavior first, then adjust if needed.
                setTimeout(() => {
                    rollSumInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100); 
            });


            checkAnswerBtn.addEventListener('click', checkAnswer);
            answerInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkAnswer();
                }
            });
            answerInput.addEventListener('focus', () => {
                // Using setTimeout to allow browser's default scroll behavior first, then adjust if needed.
                setTimeout(() => {
                    answerInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            });

            closeMessageBoxBtn.addEventListener('click', closeMessageBox);
            showRulesBtn.addEventListener('click', showRules);
            closeRulesBtn.addEventListener('click', hideRules);
        }

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase initialized and user authenticated:", userId);
                    } else {
                        console.log("No user signed in. Attempting anonymous sign-in.");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            userId = auth.currentUser?.uid || crypto.randomUUID();
                            console.log("Signed in. User ID:", userId);
                        } catch (error) {
                            console.error("Firebase authentication error:", error);
                            userId = crypto.randomUUID(); // Fallback if auth fails
                        }
                    }
                });
            } else {
                console.warn("Firebase config not found. Running game without Firebase.");
                userId = crypto.randomUUID(); // Generate a random user ID if Firebase isn't configured/used
            }
        }


        // --- Helper Functions ---
        function getDiceEmoji(num) {
            switch (num) {
                case 1: return '⚀';
                case 2: return '⚁';
                case 3: return '⚂';
                case 4: return '⚃';
                case 5: return '⚄';
                case 6: return '⚅';
                default: return '';
            }
        }

        function showMessage(title, content) {
            messageTitle.textContent = title;
            messageContent.textContent = content;
            messageBox.style.display = 'flex';
            messageBox.querySelector('button').onclick = closeMessageBox; 
        }

        function closeMessageBox() {
            messageBox.style.display = 'none';
        }

        function showRules() {
            rulesModal.style.display = 'flex';
        }

        function hideRules() {
            rulesModal.style.display = 'none';
        }

        // --- UI Update Functions ---
        function highlightCurrentPositions() {
            document.querySelectorAll('.board-cell').forEach(cell => {
                cell.classList.remove('player-active-1', 'player-active-2', 'player-active-3', 'player-active-4');
            });
            players.forEach((player, index) => {
                if (player.position > 0) {
                    const cell = document.getElementById(`cell-${player.position}`);
                    if (cell) {
                        cell.classList.add(`player-active-${index + 1}`);
                    }
                }
            });
        }

        function updatePlayerInfoDisplay() {
            if (playerInfoSection) { 
                playerInfoSection.innerHTML = ''; 
                // Clear previous grid layout if any for dynamic re-application
                playerInfoSection.style.display = 'flex';
                playerInfoSection.style.flexDirection = 'row';
                playerInfoSection.style.flexWrap = 'wrap';
                playerInfoSection.style.justifyContent = 'center';

                players.forEach((player, index) => {
                    const playerInfoDiv = document.createElement('div');
                    playerInfoDiv.id = `player-${index + 1}-info`;
                    playerInfoDiv.classList.add('text-lg', 'font-semibold');
                    const playerColor = PLAYER_COLORS[index];
                    playerInfoDiv.style.color = playerColor; 
                    const displayPosition = player.position === 0 ? '0' : `#${player.position}`;
                    
                    playerInfoDiv.textContent = `玩家 ${index + 1} ${player.token}：${displayPosition}`; 
                    
                    // Apply specific styling for 4 players to achieve 2x2 layout
                    if (players.length === 4) {
                        playerInfoDiv.style.width = 'calc(50% - 20px)'; /* Account for gap-x-20 (40px total gap, so 20px per side) */
                        playerInfoDiv.style.textAlign = 'center';
                    } else {
                        playerInfoDiv.style.width = 'auto'; /* Reset for other player counts */
                        playerInfoDiv.style.textAlign = 'center';
                    }

                    playerInfoSection.appendChild(playerInfoDiv);
                });
            }
        }

        function updatePlayerTokens() {
            document.querySelectorAll('.player-token').forEach(token => token.remove());
            
            if (startLineContainer) { 
                Array.from(startLineContainer.children).forEach(child => {
                    if (child.id !== 'start-line-label') {
                        child.remove();
                    }
                });
            }

            let allPlayersLeftStart = true; 
            players.forEach((player, index) => {
                const tokenDiv = document.createElement('div');
                tokenDiv.classList.add(`player-token-${index + 1}`); 
                tokenDiv.innerHTML = player.token;

                if (player.position === 0) {
                    tokenDiv.classList.add('start-token'); 
                    if (startLineContainer) { 
                        startLineContainer.appendChild(tokenDiv);
                    }
                    allPlayersLeftStart = false; 
                } else {
                    tokenDiv.classList.add('player-token'); 
                    const targetCell = document.getElementById(`cell-${player.position}`);
                    if (targetCell) {
                        targetCell.appendChild(tokenDiv);
                    }
                }
            });

            if (startLineContainer) { 
                if (allPlayersLeftStart) {
                    startLineContainer.classList.add('hidden'); 
                } else {
                    startLineContainer.classList.remove('hidden'); 
                }
            }
            highlightCurrentPositions(); 
        }

        // This function will *only* update the game-message div
        function updateMainGameMessageText() {
            const currentPlayer = players[currentPlayerIndex];
            const playerColor = PLAYER_COLORS[currentPlayerIndex];
            let playerTextHTML;

            playerTextHTML = `<span style="color: ${playerColor};">玩家 ${currentPlayer.name.split(' ')[1]} ${currentPlayer.token}</span>`;
            gameMessage.innerHTML = `現在是 ${playerTextHTML} 的回合！`;
        }


        function updateUI(status) {
            updatePlayerInfoDisplay(); 
            updatePlayerTokens(); 
            updateMainGameMessageText(); 

            // Hide the dice display area at the start of a new turn
            mainDiceDisplayArea.classList.add('hidden'); 
            lastRollDisplay.classList.add('hidden'); // Also hide the emoji itself
            
            actionButtons.classList.add('hidden');
            rollSumPanel.classList.add('hidden'); 
            additionPanel.classList.add('hidden'); 

            // Ensure the roll dice button is visible at the start of a turn
            // The mainDiceDisplayArea will be shown by rollDice() if it's the first roll
            rollDiceBtn.classList.remove('hidden'); 
            rollDiceBtn.disabled = false; 

            currentTurnInfo.classList.add('hidden');
            accumulatedStepsDisplay.textContent = '0'; 
            feedbackMessage.textContent = ''; 

            if (status === 'turnStart') {
                feedbackMessage.textContent = '請擲骰子。'; 
            }
        }

        // --- Core Game Logic Functions ---
        function generateBoard() {
            gameBoard.innerHTML = ''; 
            for (let i = 1; i <= 100; i++) {
                const cell = document.createElement('div');
                cell.classList.add('board-cell', 'relative');
                cell.id = `cell-${i}`;
                cell.innerHTML = `<span>${i}</span>`;
                if (i === 100) {
                    cell.classList.add('end');
                }
                gameBoard.appendChild(cell);
            }
            updatePlayerTokens(); 
        }
        
        function startGame() {
            const playerCount = parseInt(playerCountSelect.value, 10);
            players = [];
            for (let i = 0; i < playerCount; i++) {
                players.push({
                    name: `玩家 ${i + 1}`, 
                    position: 0, 
                    token: PLAYER_EMOJIS[i] || '❓' 
                });
            }
            currentPlayerIndex = 0;
            currentAccumulatedStepsThisTurn = 0;
            lastRollValue = 0;
            currentQuestionCorrectAnswer = 0;

            startScreen.classList.add('hidden');
            gameInterface.classList.remove('hidden');
            roll1Reminder.classList.remove('hidden'); 
            
            // Adjust roll1Reminder text based on player count
            roll1Reminder.textContent = '💡 如果擲到 1 點，本回合步數歸 0，換下家！';

            generateBoard(); 
            updatePlayerInfoDisplay(); 
            updateUI('turnStart'); 
        }

        function rollDice() {
            playDiceRollSound(); // Play dice roll sound
            rollDiceBtn.disabled = true;
            rollAgainBtn.disabled = true;
            moveStepsBtn.disabled = true;
            actionButtons.classList.add('hidden'); 
            
            rollDiceBtn.classList.add('hidden'); 

            const roll = Math.floor(Math.random() * 6) + 1; 
            lastRollValue = roll; 
            
            mainDiceDisplayArea.classList.remove('hidden'); // Show the dice display area
            lastRollDisplay.textContent = getDiceEmoji(roll);
            lastRollDisplay.classList.remove('hidden');
            lastRollDisplay.style.animation = 'none'; 
            void lastRollDisplay.offsetWidth; 
            lastRollDisplay.style.animation = 'roll-anim 0.5s ease-out';


            if (roll === 1) {
                playPenaltySound(); // Play penalty sound for rolling a 1 (failure sound)
                feedbackMessage.innerHTML = `擲出 ${getDiceEmoji(roll)} (1)！歸零，換家。`; 
                currentAccumulatedStepsThisTurn = 0; 
                currentTurnInfo.classList.add('hidden'); 
                rollSumPanel.classList.add('hidden');
                additionPanel.classList.add('hidden');
                
                // FIX: Ensure UI is fully reset before ending turn
                // Re-show and re-enable the roll dice button for the next player
                rollDiceBtn.classList.remove('hidden'); 
                rollDiceBtn.disabled = false; 

                setTimeout(() => {
                    feedbackMessage.textContent = ''; 
                    endTurn(); 
                }, 2000);
            } else {
                if (currentAccumulatedStepsThisTurn === 0) {
                    currentAccumulatedStepsThisTurn = roll;
                    currentTurnInfo.classList.remove('hidden');
                    accumulatedStepsDisplay.textContent = currentAccumulatedStepsThisTurn;
                    actionButtons.classList.remove('hidden');
                    rollAgainBtn.disabled = false;
                    moveStepsBtn.disabled = false;
                    feedbackMessage.textContent = `擲出 ${getDiceEmoji(roll)} (${roll})，累積 ${currentAccumulatedStepsThisTurn} 步！`;
                    setTimeout(() => {
                        feedbackMessage.textContent = ''; 
                    }, 1500); 
                } else {
                    feedbackMessage.textContent = ''; 
                    promptRollSum();
                }
            }
        }

        function promptRollSum() {
            rollDiceBtn.classList.add('hidden'); 
            actionButtons.classList.add('hidden'); 

            const previousAccumulated = currentAccumulatedStepsThisTurn;
            const currentRoll = lastRollValue;
            const currentPlayer = players[currentPlayerIndex];
            const playerColor = PLAYER_COLORS[currentPlayerIndex];
            
            const playerDisplayName = `玩家 ${currentPlayer.name.split(' ')[1]}`;
            const playerColoredText = `<span style="color: ${playerColor};">${playerDisplayName} ${currentPlayer.token}</span>`;

            rollSumQuestion.innerHTML = `擲出 ${getDiceEmoji(currentRoll)} (${currentRoll})，累積步數：${previousAccumulated} + ${currentRoll} =？`;
            currentQuestionCorrectAnswer = previousAccumulated + currentRoll;
            
            rollSumInput.value = ''; 
            rollSumPanel.classList.remove('hidden'); 
            
            feedbackMessage.innerHTML = `${playerColoredText}，算算累積了多少步？`;
            
            rollSumInput.focus();
            rollSumInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); // Auto-scroll on focus
            checkRollSumBtn.disabled = false; 
        }

        function checkRollSum() {
            checkRollSumBtn.disabled = true; 
            const playerAnswer = parseInt(rollSumInput.value, 10);
            const currentPlayer = players[currentPlayerIndex];
            const playerColor = PLAYER_COLORS[currentPlayerIndex];
            const playerDisplayName = `玩家 ${currentPlayer.name.split(' ')[1]}`;
            const playerColoredText = `<span style="color: ${playerColor};">${playerDisplayName} ${currentPlayer.token}</span>`;


            if (isNaN(playerAnswer)) {
                playIncorrectSound(); // Play incorrect sound
                showMessage("錯誤", "請輸入一個有效的數字！");
                checkRollSumBtn.disabled = false;
                rollSumInput.focus();
                messageBox.querySelector('button').onclick = () => {
                    closeMessageBox();
                    feedbackMessage.innerHTML = `${playerColoredText}，算算累積了多少步？`;
                };
                return;
            }

            if (playerAnswer === currentQuestionCorrectAnswer) {
                playCorrectSound(); // Play correct sound
                feedbackMessage.textContent = '計算正確！'; 
                setTimeout(() => { 
                    feedbackMessage.textContent = ''; 
                    updateMainGameMessageText(); 
                }, 1000);

                currentAccumulatedStepsThisTurn = playerAnswer; 
                rollSumPanel.classList.add('hidden'); 

                actionButtons.classList.remove('hidden');
                rollAgainBtn.disabled = false;
                moveStepsBtn.disabled = false;

                currentTurnInfo.classList.remove('hidden');
                accumulatedStepsDisplay.textContent = currentAccumulatedStepsThisTurn;
            } else {
                playIncorrectSound(); // Play incorrect sound
                feedbackMessage.textContent = '計算錯誤！請重新計算。'; 
                showMessage("計算錯誤", `你的答案是 ${playerAnswer}。請重新計算。`);
                rollSumInput.value = ''; 
                checkRollSumBtn.disabled = false; 
                rollSumInput.focus(); 
                messageBox.querySelector('button').onclick = () => {
                    closeMessageBox();
                    feedbackMessage.innerHTML = `${playerColoredText}，算算累積了多少步？`;
                };
                return; 
            }
        }

        function handleMoveSteps() {
            const currentPlayer = players[currentPlayerIndex];

            if (currentPlayer.position === 0) {
                const newPosition = currentAccumulatedStepsThisTurn; 
                currentPlayer.position = newPosition;
                updatePlayerTokens();
                if (newPosition >= 100) {
                    playWinSound(); // Play win sound
                    showMessage("遊戲結束！", `${currentPlayer.name} 抵達 100！恭喜獲勝！🎉`);
                    resetGame();
                    return;
                }
                playMoveSound(); // Play move sound if not winning
                const playerDisplayName = `玩家 ${currentPlayer.name.split(' ')[1]}`;
                const playerText = `<span style="color: ${PLAYER_COLORS[currentPlayerIndex]};">${playerDisplayName} ${currentPlayer.token}</span>`;
                feedbackMessage.innerHTML = `${playerText} 前進到 ${newPosition}！`;
                rollSumPanel.classList.add('hidden');
                additionPanel.classList.add('hidden');
                mainDiceDisplayArea.classList.add('hidden'); // Hide dice display when moving
                setTimeout(() => {
                    feedbackMessage.textContent = '';
                    endTurn();
                }, 2000);
            } else {
                promptNewPosition();
            }
        }

        function promptNewPosition() {
            rollAgainBtn.disabled = true;
            moveStepsBtn.disabled = true;
            rollDiceBtn.classList.add('hidden');
            actionButtons.classList.add('hidden'); 
            currentTurnInfo.classList.add('hidden'); 
            mainDiceDisplayArea.classList.add('hidden'); // Hide dice display when moving to addition

            const currentPlayer = players[currentPlayerIndex];
            const currentPosition = currentPlayer.position;
            const stepsToMove = currentAccumulatedStepsThisTurn; 
            const playerColor = PLAYER_COLORS[currentPlayerIndex];
            const playerDisplayName = `玩家 ${currentPlayer.name.split(' ')[1]}`;
            const playerText = `<span style="color: ${playerColor};">${playerDisplayName} ${currentPlayer.token}</span>`;

            // Changed: Removed "新位置："從問題中移除
            additionQuestion.innerHTML = `從 ${currentPosition} 前進 ${stepsToMove} 步：${currentPosition} + ${stepsToMove} =？`;
            currentQuestionCorrectAnswer = currentPosition + stepsToMove; 
            answerInput.value = ''; 

            rollSumPanel.classList.add('hidden'); 
            additionPanel.classList.remove('hidden'); 
            
            feedbackMessage.innerHTML = `${playerText} 請計算新位置：`;
            
            answerInput.focus();
            answerInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); // Auto-scroll on focus
            checkAnswerBtn.disabled = false; 
        }

        function checkAnswer() {
            checkAnswerBtn.disabled = true; 
            const playerAnswer = parseInt(answerInput.value, 10);
            const currentPlayer = players[currentPlayerIndex];
            const playerColor = PLAYER_COLORS[currentPlayerIndex];
            const playerDisplayName = `玩家 ${currentPlayer.name.split(' ')[1]}`;
            const playerText = `<span style="color: ${playerColor};">${playerDisplayName} ${currentPlayer.token}</span>`;


            if (isNaN(playerAnswer)) {
                playIncorrectSound(); // Play incorrect sound
                showMessage("錯誤", "請輸入一個有效的數字！");
                checkAnswerBtn.disabled = false;
                answerInput.focus();
                messageBox.querySelector('button').onclick = () => {
                    closeMessageBox();
                    feedbackMessage.innerHTML = `${playerText} 請計算新位置：`;
                };
                return;
            }

            if (playerAnswer === currentQuestionCorrectAnswer) {
                playCorrectSound(); // Play correct sound
                feedbackMessage.textContent = '計算正確！'; 
                setTimeout(() => { 
                    feedbackMessage.textContent = ''; 
                    movePlayerAfterCalculation(); 
                }, 1000);
                
            } else {
                playIncorrectSound(); // Play incorrect sound
                feedbackMessage.textContent = '計算錯誤！請重新計算。'; 
                showMessage("計算錯誤", `你的答案是 ${playerAnswer}。請重新計算。`);
                answerInput.value = ''; 
                checkAnswerBtn.disabled = false; 
                answerInput.focus(); 
                messageBox.querySelector('button').onclick = () => {
                    closeMessageBox();
                    feedbackMessage.innerHTML = `${playerText} 請計算新位置：`;
                };
                return; 
            }
        }

        function movePlayerAfterCalculation() {
            const currentPlayer = players[currentPlayerIndex];
            let newPosition = currentQuestionCorrectAnswer; 
            const playerDisplayName = `玩家 ${currentPlayer.name.split(' ')[1]}`;
            const playerText = `<span style="color: ${PLAYER_COLORS[currentPlayerIndex]};">${playerDisplayName} ${currentPlayer.token}</span>`;


            if (newPosition >= 100) {
                newPosition = 100; 
                currentPlayer.position = newPosition;
                updatePlayerTokens();
                playWinSound(); // Play win sound
                showMessage("遊戲結束！", `${currentPlayer.name} 抵達 100！恭喜獲勝！🎉`);
                resetGame(); 
                return;
            }

            currentPlayer.position = newPosition;
            updatePlayerTokens(); 
            playMoveSound(); // Play move sound
            feedbackMessage.innerHTML = `${playerText} 前進到 ${newPosition}！`; 

            additionPanel.classList.add('hidden');
            mainDiceDisplayArea.classList.add('hidden'); // Hide dice display after moving

            setTimeout(() => {
                feedbackMessage.textContent = ''; 
                endTurn(); 
            }, 2000);
        }


        function endTurn() {
            currentAccumulatedStepsThisTurn = 0;
            lastRollValue = 0;
            currentQuestionCorrectAnswer = 0;

            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            playPlayerTurnSound(); // Play sound when turn changes
            updateUI('turnStart'); 
        }

        function resetGame() {
            players.forEach(player => player.position = 0);
            currentPlayerIndex = 0;
            currentAccumulatedStepsThisTurn = 0;
            lastRollValue = 0;
            currentQuestionCorrectAnswer = 0;

            startScreen.classList.remove('hidden');
            gameInterface.classList.add('hidden');
            roll1Reminder.classList.add('hidden'); 
            gameMessage.textContent = "";
            feedbackMessage.textContent = ""; 
            playerInfoSection.innerHTML = ""; 
            gameBoard.innerHTML = ""; 
            startLineContainer.classList.add('hidden'); 
            mainDiceDisplayArea.classList.add('hidden'); // Ensure dice display is hidden on reset
            lastRollDisplay.classList.add('hidden'); 
        }
        
        // --- Initialize DOM elements and Firebase when the window loads ---
        window.onload = async function() {
            initDomElements(); 
            initAudioSynths(); // Initialize Tone.js synths
            await initializeFirebase(); 
        };
    </script>
</body>
</html>

